<html>
  <head>
    <script src="js/jquery-1.7.1.min.js"></script> 
    <script src="js/underscore-min.js"></script> 
    <script src="js/ejs.min.js"></script>
    <script src="js/backbone-min.js"></script>
    
    <script src="lib/cpu_constants.js"></script> 
    <script src="lib/cpu.js"></script> 
    <script src="lib/scanner.js"></script> 
    <script src="lib/assembler.js"></script> 
    <script src="lib/deassembler.js"></script> 
    
    
    <script src="lib/cpu_view.js"></script> 
    
    <script type="text/template" id="debugger_template">
      <table id="debugger_source" border>
        <% for(var i=0;i<lines.length;i++) { %>
        <tr id='<%= i %>'>
          <td width="20px"></td>
          <td><%= zero_fill(lines[i].mem_pos.toString(16),4) %></td>
          <td><%= lines[i].txt %></td>
          <td>
            <% for(var j=0;j<lines[i].byte_code.length;j++) { %> <%= zero_fill(lines[i].byte_code[j].toString(16),4) %>  <% } %>
          </td>
        </tr>
        <% } %>
      </table>
    </script>
    
    <script type="text/template" id="cpu_template">
      <table border>
        <tr>
          <td>PC</td><td><%= cpu.pc %></td>
          <td>Cycle</td><td><%= cpu.cycle %></td>
        </tr>
        <tr>
          <td>SP</td><td><%= cpu.sp %></td>
        </tr>
      </table>
      <table border>
        <tr>
          <% for(var i=0;i<cpu.registers_ordered.length;i++) { %>
            <td><%= cpu.registers_ordered[i] %></td>
          <% } %>
        <tr>
        <tr>
          <% for(var i=0;i<cpu.registers_ordered.length;i++) { %>
            <td>0x<%= cpu.registers[cpu.registers_ordered[i]].toString(16).toUpperCase() %></td>
          <% } %>
        <tr>
        <tr>
      </table>
      <table>
        <% for(var r=0;r<20;r++) { %>
        <tr>
          <td><%= zero_fill((r*8).toString(16),4) %>:</td>
          <% for(var c=0;c<8;c++) { %>
            <% var cur_index = (r*8)+c %>
            <% if(cur_index == cpu.pc) { %>
              <td id='current_pc'><%= zero_fill(cpu.memory[cur_index].toString(16),4) %></td>
            <% } else { %>
              <td><%= zero_fill(cpu.memory[cur_index].toString(16),4) %></td>
            <% } %>
          <% } %>
        </tr>
        <% } %>
      </table>
    </script>
    
    <script>
      var current_c=0;
      var assembly = null; 
      var deassembly = null;
    
      var step = function() {
        if(deassembly==null) return;
        for(var i=0;i<deassembly.lines[current_c].byte_code.length;i++) {
          cpu.step();
        }
        var tmp = 0;
        for(var i=0;i<deassembly.lines.length;i++) {
          if(cpu.pc==deassembly.lines[i].mem_pos) {
            current_c = i;
            break;
          }
        }
        show_cpu();
        show_debugger();
      };
      
      var show_debugger = function() {
        if(deassembly == null) return;
        $('#debugger').html(ejs.render($('#debugger_template').html(),{lines:deassembly.lines}));
        $('#debugger_source').find('#'+current_c).css('backgroundColor', 'yellow');
        $('#debugger_source').find('tr').click( function() {
          alert('Setting breakpoint '+this.id);
        });
      };
      
      var stop_signal = false;
      var run_step = function() {
        if(!stop_signal) {
          step();
          setTimeout("run_step()",$('#run_delay').val());
        }
      };
    
      $( function() {
        cpu.reset();
        show_cpu();
        
        $('#step').click( function() {
          step();  
        });

        $('#reset').click( function() {
          stop_signal = true;
          current_c=0;
          cpu.reset();
          cpu.load(0,assembly.byte_code);
          show_cpu();
          show_debugger();  
        });
        
        $('#compile').click( function() {
          current_c=0;
          cpu.reset();
          assembly = assemble($('#source').val());
          deassembly = deassemble(assembly.byte_code,assembly.labels);
          cpu.load(0,assembly.byte_code);
          show_cpu();
          show_debugger();
        });

        $('#run').click( function() {
          stop_signal = false;
          run_step();
        });

        $('#stop').click( function() {
          stop_signal = true;
        });
        

        
        var test_asm = 'SET [0x30],0x40\nIFE [0x30],0x40\nloop: ADD B,1\nSET PC,loop';
        $('#source').val(test_asm);
        
      });
    </script>
    
  </head>
  <body>
    <table border>
      <tr>
        <td>
          <button id='compile'>compile</button>
        </td>
        <td width="300px">
          <button id='run'>run</button>
          <input type='text' value='500' id='run_delay' style='width:50px'/>
          <button id='stop'>stop</button>
          <button id='step'>step</button>
          <button id='reset'>reset</button>
        </td>
        <td>
        </td>
      <tr>
      <tr height="100%">
        <td width="300px">
          <textarea id='source' style="width:100%;height:100%"></textarea>
        </td>
        <td width="300px" valign="top">
          <div id="debugger"></div>
        </td>
        <td>
          <table>
            <tr>
              <td>
                <!--canvas id="myCanvas" width="320" height="200"></canvas-->  
              </td>
            </tr>
            <tr>
              <td>
                <div id="cpu"></div>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </body>
</html>