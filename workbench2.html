<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>DCPU16 Workbench2 (version:dev)</title>
 		<link type="text/css" href="style/css/ui-lightness/jquery-ui-1.8.18.custom.css" rel="stylesheet" />	
    <link type="text/css" href="style/css/style.css" rel="stylesheet" />	
		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="style/js/jquery-ui-1.8.18.custom.min.js"></script>
    <script src="js/underscore-min.js"></script> 
    <script src="js/ejs.min.js"></script>
    <script src="js/backbone-min.js"></script>

    
    <script src="lib/cpu_constants.js"></script> 
    <script src="lib/cpu.js"></script> 
    <script src="lib/assembler.js"></script> 
    <script src="lib/deassembler.js"></script> 
    <script src="lib/debugger.js"></script> 
    <script src="lib/codestore.js"></script> 
    <script src="lib/cpu_view.js"></script> 
    <script src="lib/dyno_edit.js"></script> 

    <script src="lib/screen.js"></script> 
    
    <script>
      $(function() {
        $('#tabs').tabs();
      });
    </script>
  
    <script type="text/template" id="error_list_template">
      <table id='error_list' cellspacing=0 width="100%">
        <% for(var i=0;i<errors.length;i++) { %>
        <% var error = errors[i] %>
          <tr>
            <td><%= error.line %></td>
            <td><%= error.type %></td>
            <td><%= error.msg %></td>
          </tr>
        <% } %>
      </table>
    </script>

    <script type="text/template" id="code_list_template">
      <table id='code_list' cellspacing=0 width="100%">
        <% for(var i=0;i<codes.length;i++) { %>
        <tr id='<%= codes[i].key %>'>
          <td><%= codes[i].name %></td>
          <td><%= codestore.load('code',codes[i].name).split('\n')[0] %></td> 
          <td><span class="ui-icon ui-icon-close delete_code_button"></span></td>
        </tr>
        <% } %>
      </table>
    </script>
    
    <script type="text/template" id="debugger_template">
      <table id="debugger_source" class='code' cellspacing=0 width="100%">
        <% for(var i=0;i<lines.length;i++) { %>
        <tr id='<%= i %>'>
          <td width="20px" class='breakpoint' id='<%= lines[i].mem_pos %>'>
            <% if(breakpoints.indexOf(lines[i].mem_pos)!=-1) { %>
              <span class='ui-icon ui-icon-star'/>
            <% } else { %>
              <span/>
            <% } %>
          </td>
          <td width="0%"><%= zero_fill(lines[i].mem_pos.toString(16),4) %>:</td>
          <td><%= lines[i].txt %></td>
          <td>
            <% for(var j=0;j<lines[i].byte_code.length;j++) { %> <%= zero_fill(lines[i].byte_code[j].toString(16),4) %>  <% } %>
          </td>
        </tr>
        <% } %>
      </table>
    </script>
    
    <script type="text/template" id="cpu_template">
      <table>
        <tr>
          <td class="register_label">PC:</td><td class="register_value dyno_register" id="PC"><%= zero_fill(cpu.pc.toString(16),4) %></td>
          <td class="register_label">SP:</td><td class="register_value"><%= zero_fill(cpu.sp.toString(16),4) %></td>
          <td class="register_label">Cycle:</td><td class="register_value"><%= zero_fill(cpu.cycle,4) %></td>
        </tr>
        <tr>
          <td class="register_label">A:</td><td class="register_value"><%= zero_fill(cpu.registers.A.toString(16),4) %></td>
          <td class="register_label">B:</td><td class="register_value"><%= zero_fill(cpu.registers.B.toString(16),4) %></td>
          <td class="register_label">C:</td><td class="register_value"><%= zero_fill(cpu.registers.C.toString(16),4) %></td>
        </tr>
        <tr>
          <td class="register_label">X:</td><td class="register_value"><%= zero_fill(cpu.registers.X.toString(16),4) %></td>
          <td class="register_label">Y:</td><td class="register_value"><%= zero_fill(cpu.registers.Y.toString(16),4) %></td>
          <td class="register_label">Z:</td><td class="register_value"><%= zero_fill(cpu.registers.Z.toString(16),4) %></td>
        </tr>
        <tr>
          <td class="register_label">I:</td><td class="register_value"><%= zero_fill(cpu.registers.I.toString(16),4) %></td>
          <td class="register_label">J:</td><td class="register_value"><%= zero_fill(cpu.registers.J.toString(16),4) %></td>
          <td></td>
        </tr>
      </table>
      <table id="memory">
        <tr>
          <td colspan='9'><input id='memory_offset'/></td>
        </td>
        <% for(var r=0;r<20;r++) { %>
        <tr>
          <td class='memory_cell label'><%= zero_fill(((r*8)+parseInt(memory_offset)).toString(16),4) %>:</td>
          <% for(var c=0;c<8;c++) { %>
            <% var cur_index = (r*8)+c + parseInt(memory_offset) %>
            <% if(cur_index == cpu.pc) { %>
              <td id='<%= cur_index %>' class='memory_cell current_pc'><%= zero_fill(cpu.get_memory(cur_index).toString(16),4) %></td>
            <% } else { %>
              <td id='<%= cur_index %>' class='memory_cell'><%= zero_fill(cpu.get_memory(cur_index).toString(16),4) %></td>
            <% } %>
          <% } %>
        </tr>
        <% } %> 
      </table>
    </script>

    <script>
      var dbg = new Debugger();
      var start_position = 0;
      
      
      var show_debugger = function() {
        if(dbg.assembly.errors.length>0) {
          $('#debugger').html(ejs.render($('#error_list_template').html(),{errors:dbg.assembly.errors}));          
        } else {
          $('#debugger').html(ejs.render($('#debugger_template').html(),{lines:dbg.deassembly.lines,breakpoints:dbg.breakpoints}));
          $('#debugger_source').find('tr#'+dbg.current_line).css('backgroundColor', 'wheat');
          $('td.breakpoint').click( function() {
            $(this).children('span').toggleClass('ui-icon').toggleClass('ui-icon-star');
            dbg.toggle_breakpoint(this.id);
          });
        }

        $('.dyno_register').click(dyno(function(id,val) { 
          if(id == 'PC') 
            dbg.cpu.pc = parseInt(val);
          else
            dbg.cpu.registers[id] = parseInt(val);
          
          show_cpu();
          show_debugger();
        }));

        
      };
   
      show_screen = function() {
        update_screen($('#preview_screen')[0],dbg.cpu.memory.slice(0x8000,0x8000+180),dbg.cpu.memory.slice(0x8180,0x8180+(256*2)),3);
      };
   
      $( function() {
        show_cpu();
        show_screen();
        
        $('#step').click( function() {
          dbg.step();
          show_cpu();
          show_screen();
          show_debugger();
        });

        $('#reset').click( function() {
          dbg.reset();
          show_cpu();
          show_debugger();
          show_screen();          
        });
        
        $('#compile').click( function() {
          dbg.load(start_position,$('#source').val());
          $('#debugger_tab_tab').click();
          show_cpu();
          show_debugger();
          show_screen();
        });

        $('#run').click( function() {
          dbg.run(function() { show_cpu();show_debugger();show_screen(); });
        });

        $('#stop').click( function() {
          dbg.pause();
        });
      });
    </script>
 
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29004947-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  
  </head>
  <body>
    <h1>DCPU-16 Workbench (version:dev)</h1>
    <a href="http://github.com/whoatemydomain/js-dcpu16_workbench"> 
		  <img alt="Fork me on GitHub" id="ribbon" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png"> 
		</a>
  
    <p>
      <a href="#" id="new" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>new</a>
      <a href="#" id="save" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>save</a>
      <a href="#" id="save as" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>save as</a>
      <a href="#" id="load" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>load</a>
      <a href="#" id="compile" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>compile</a>
      <a href="#" id="about"  style='float:right' class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>about</a>
      <a href="#" id="settings"  style='float:right' class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>settings</a>
    </p>

 		<div id="tabs">
			<ul>
				<li><a href="#editor_tab">editor</a></li>
				<li><a href="#debugger_tab" id="debugger_tab_tab">debugger</a></li>
        <li><a href="#output_tab">output</a></li>
			</ul>
			<div id="editor_tab">
        <table style="width:100%;height:100%">
          <tr valign='top' style='height:0'>
            <td><input type='text' id='source_label' style='width:100%' disabled></input></td>
          </tr>
          <tr valign="top">
            <td colspan='2'><textarea id='source' cols='80' wrap='off' style='width:100%;height:100%' class='CodeMirror-scroll cm-s-default'  disabled></textarea></td>
          </tr>
        </table>
      </div>
      <div id="output_tab">
        <canvas id="screen" width="420" height="320"></canvas>
      </div>
			<div id="debugger_tab">
        <p>
          <a href="#" id="run" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-play"></span>run</a>
          <a href="#" id="stop" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-pause"></span>stop</a>
          <a href="#" id="step" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-seek-next"></span>step</a>
          <a href="#" id="reset" class="dialog_link ui-state-default ui-corner-all"><span class="ui-icon ui-icon-refresh"></span>reset</a>
        </p>
        <table style="width:100%;height:100%">
          <td width="50%" valign="top">
            <div id="debugger"></div>
          </td>
          <td align="right" valign="top">
            <table>
              <tr>
                <td>
                  <canvas id="preview_screen" width="256" height="96"></canvas>
                </td>
              </tr>
              <tr>
                <td>
                  <div id="cpu"></div>
                </td>
              </tr>
            </table>
          </td>
        </table>
      </div>
		</div>
    <div class="fb-like" data-href="http://dcpu16_workbench.whoatemydomain.co.za//" data-send="true" data-width="450" data-show-faces="false"></div>


    <div id='load_dialog'>
      <div id='code_list'></div>
    </div>
    <div id='about_dialog'>
	  <p>
        <a href='https://github.com/whoatemydomain/js-dcpu16_workbench' target='_blank' id="dialog_link" class="ui-state-default ui-corner-all">
	      <span class="ui-icon ui-icon-newwin"></span>Source at GitHub</a>
        <a href='https://github.com/whoatemydomain/js-dcpu16_workbench/wiki/Quick-Start' target='_blank' id="dialog_link" class="ui-state-default ui-corner-all">
		  <span class="ui-icon ui-icon-newwin"></span>Quick Start</a>
        <a href='https://github.com/whoatemydomain/js-dcpu16_workbench/issues' target='_blank' id="dialog_link" class="ui-state-default ui-corner-all">
		  <span class="ui-icon ui-icon-newwin"></span>Issues</a>
      </p>
	
    </div>
    
    <div id='settings_dialog'>
      <table>
        <tr>
          <td>Delay between steps</td>
          <td>:<input type='text' id='settings_run_delay' style='width:50px'/> ms</td>
        </tr>
        <tr>
          <td>Load code to</td>
          <td>:<input type='text' id='settings_start_position' style='width:50px'/></td>
        </tr>
      </table>
    </div>
    
    <div id='new_dialog'>
      <table>
        <tr>
          <td>Name</td>
          <td>: <input type='text' id='new_name' style='width:150px'/> </td>
        </tr>
      </table>
    </div>

    <div id='saveas_dialog'>
      <table>
        <tr>
          <td>Name</td>
          <td>: <input type='text' id='saveas_name' style='width:150px'/> </td>
        </tr>
      </table>
    </div>
    
  </body>
  
    <script>
    dbg.run_delay = codestore.loadInt('settings','run_delay',200);
    start_position = codestore.loadInt('settings','start_position',0);
        
  
    $('button').button();
    $('#tabs').tabs();
    $('#load_dialog').dialog({
      autoOpen: false,
      width: 600,
      height: 300,
      modal: true,
      title : 'load',
      buttons: {
        "ok": function() { 
          var key = $('#code_list').find('.selected').attr('id');
          if(typeof(key) != 'undefined') { 
            var keyParts = codestore.splitKey(key);
            code_label = keyParts.key;  
            $('#source').val(codestore.load(keyParts.table,keyParts.key,''));
            $('#source').removeAttr('disabled');
            pending_changes = false;
            $('#source_label').val(code_label);
          }
          $(this).dialog("close"); 
        }, 
        "cancel": function() { 
          $(this).dialog("close"); 
        } 
      }
    });
    var codes = [];
    $('#load').click(function() {
      codes = codestore.findKeys('code');
      $('#code_list').html(ejs.render($('#code_list_template').html(),{codes:codes}));
      $('#code_list').find('tr').click(function() { 
        $('#code_list').find('tr').removeClass('selected');
        $(this).toggleClass('selected'); 
      });
      $('.delete_code_button').click(function() { 
        $('#code_list').find('tr').removeClass('selected');
        var key = $(this).parent().parent().attr('id');
        var keyParts = codestore.splitKey(key);
        codestore.delete(key);
        $(this).parent().parent().remove();
        if(keyParts.key == code_label) {
          pending_changes = true;
          handle_code_changes();
        }
      });

      $('#load_dialog').dialog('open');
      return false;
    });
    
    $('#settings_dialog').dialog({
      autoOpen: false,
      width: 600,
      modal: true,
      title : 'settings',
      buttons: {
        "ok": function() { 
          $(this).dialog("close"); 
          dbg.run_delay = $('#settings_run_delay').val();
          start_position = $('#settings_start_position').val();;
          
          codestore.save('settings','run_delay',dbg.run_delay);
          codestore.save('settings','start_position',start_position);
        }, 
        "cancel": function() { 
          $(this).dialog("close"); 
        } 
      }
    });
    $('#settings').click(function(){
      $('#settings_run_delay').val(dbg.run_delay);
      $('#settings_start_position').val(start_position);
      $('#settings_dialog').dialog('open');
      return false;
    });
    
    $('#about_dialog').dialog({
      autoOpen: false, width: 600, modal: true, title : 'help about',
      buttons: { "ok": function() { $(this).dialog("close"); }, }
    });
    $('#about').click(function(){ $('#about_dialog').dialog('open'); return false; });


    handle_code_change = function() {
      if(pending_changes) return;
      pending_changes = true;
      $('#source_label').val('*'+code_label);
    }
    
    var code_label='';
    var pending_changes=false;
    $('#new_dialog').dialog({
      autoOpen: false, width: 600, modal: true, title : 'new',
      buttons: {
        "ok": function() { 
          $(this).dialog("close"); 
          code_label = $('#new_name').val();
          pending_changes = false;
          $('#new_name').val('');
          $('#source_label').val(code_label);
          $('#source').removeAttr('disabled');
          $('#source').val('');
          handle_code_change();
        }, 
        "cancel": function() { $(this).dialog("close"); } 
      }
    });
    $('#new').click(function(){ $('#new_dialog').dialog('open'); return false; });

    $('#saveas_dialog').dialog({
      autoOpen: false, width: 600, modal: true, title : 'Save As',
      buttons: {
        "ok": function() { 
          $(this).dialog("close"); 
          code_label = $('#saveas_name').val();
          pending_changes = true;
          $('#saveas_name').val('');
          $('#source_label').val(code_label);
          codestore.save('code',code_label,$('#source').val());
          handle_code_change();
        }, 
        "cancel": function() { $(this).dialog("close"); } 
      }
    });
    $('#saveas').click(function(){ $('#saveas_dialog').dialog('open'); return false; });

    
    
    $('#source').change( function() {
      handle_code_change();
    });
  
    $('#source').keypress( function() {
      handle_code_change();
    });
    $('#save').click( function() {
      pending_changes = false;
      $('#source_label').val(code_label);
      codestore.save('code',code_label,$('#source').val());
    });
    $('#source').keydown( function(e) {
      if(e.keyCode === 9) { // tab was pressed
        // get caret position/selection
        var start = this.selectionStart;
            end = this.selectionEnd;

        var $this = $(this);

        // set textarea value to: text before caret + tab + text after caret
        $this.val($this.val().substring(0, start)
                    + "\t"
                    + $this.val().substring(end));

        // put caret at right position again
        this.selectionStart = this.selectionEnd = start + 1;

        // prevent the focus lose
        return false;
    }
    });
    
  </script>

</html>
  